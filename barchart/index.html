<!DOCTYPE html>
<meta charset="utf-8">
<style>
    @font-face {
        font-family: encode;
        src: url('http://static.ehouais.net/EncodeSansCondensed-Regular.ttf') format("truetype");
    }
    body {
        font-family: encode;
        margin: 0;
        border: 0;
        overflow: hidden;
    }
    text {
        font: 10px;
        text-anchor: middle;
    }
    .axis text {
        font: 10px;
    }
    .axis path {
        display: none;
    }
    .axis line {
        fill: none;
        stroke: #000;
        shape-rendering: crispEdges;
    }
    .axis .minor line {
        stroke: #999;
        stroke-dasharray: 1,2;
    }
</style>
<body>
<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/sjcl/1.0.0/sjcl.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
<script src="http://dev.ehouais.net/webviews/webviews.js"></script>
<script>
    var svg = d3.select('body').append('svg'),
        chart = svg.append('g'),
        xScale = d3.scale.ordinal(),
        xAxis = d3.svg.axis()
            .scale(xScale),
        xx = chart.append('g')
            .attr('class', 'x axis'),
        yScale = d3.scale.linear(),
        yAxis = d3.svg.axis()
            .scale(yScale)
            .orient('left'),
        yy = chart.append('g')
            .attr('class', 'y axis'),
        cScale = d3.scale.category10(),
        nb,
        indexes,
        data,
        labels,
        legend,
        groups,
        bars,
        rects,
        text,
        lrects,
        ltexts,
        dataUri = Webviews.uriParams(window.location.href).datauri,
        resize = Webviews.resize({top: [20, 50], right: [20, 50], bottom: [30, 50], left: [30, 50]}, function(width, height, margins) {
            var cwidth = width-margins.left-margins.right,
                cheight = height-margins.top-margins.bottom,
                fs = Math.max(Math.min(Math.min(cwidth, cheight)/20, 20), 10),
                heights = [];

            svg
                .attr('width', width)
                .attr('height', height);

            chart
                .attr('transform', 'translate('+margins.left+','+margins.top+')');

            xScale
                .rangeRoundBands([0, cwidth], nb > 1 ? 0.2 : 0.1);

            xx
                .attr('transform', 'translate(0,' + cheight + ')')
                .call(xAxis)
                .selectAll('text')
                .text(function(d, i) { return data[i].label || ''; })
                .style('font-size', fs+'px');

            yScale
                .range([cheight, 0]);

            yAxis
                .ticks(cheight/20)
                .tickSize(-cwidth);

            yy
                .call(yAxis)
                .selectAll('text')
                .style('font-size', fs+'px');

            yy
                .selectAll('g')
                .filter(function(d) { return d; })
                .classed('minor', true);

            groups
                .attr('transform', function(d, i) { return 'translate('+xScale(i)+',0)'; });

            rects
                .attr('x', function(d, i) { return indexes[i]*Math.ceil(xScale.rangeBand()/nb); })
                .attr('y', function(d, i) {
                    var index = d3.select(this.parentNode.parentNode).datum().index;

                    heights[index] = heights[index] || [];
                    heights[index][indexes[i]] = (heights[index][indexes[i]] || 0) + d;
                    return yScale(heights[index][indexes[i]]);
                })
                .attr('width', Math.ceil(xScale.rangeBand()/nb))
                .attr('height', function(d) { return cheight-yScale(d); });

            legend
                .attr('transform', function(d, i) { return 'translate(0,'+(margins.top+i*20)+')'; });

            lrects
                .attr('x', width-margins.right-18);

            ltexts
                .attr('x', width-margins.right-24)
                .style('font-size', fs+'px');
        });

    // text/plain: {label1,label2,label3}label:val11,val12,val13|label:val21,val22, val23
    d3.xhr(dataUri).get().on('load', function(xhr) {
        var str = xhr.response,
            res,
            tokens,
            index = 0,
            max = [];

        data = [];
        labels = [];
        indexes = [];

        // get serie labels
        if (res = str.match(/^\{([^\}]+)\}(.*)/)) {
            tokens = res[1].split(',');
            nb = tokens.length;
            tokens.forEach(function(token, i) {
                token.split('+').forEach(function(label) {
                    labels.push(label);
                    indexes[index++] = i;
                });
            });
            str = res[2];
        } else {
            indexes = d3.range(nb);
        }

        // get serie values
        str.split('|').forEach(function(value, i) {
            var tokens = value.split(':');
            if (tokens.length == 1) {
                tokens.unshift('');
            }
            data[i] = {
                index: i,
                label: tokens[0], // group label
                values: tokens[1].split(',').map(function(val) { return +val; })
            };
        });

        if (!nb) {
            nb = data[0].values.length;
            labels = indexes.map(function(i) { return 'series #'+(i+1); })
        }

        xScale.domain(d3.range(data.length)),
        yScale.domain([0, d3.max(data, function(d) {
            return d3.max(d.values.reduce(function(stacks, value, i) {
                var index = indexes[i];
                stacks[index] = (stacks[index] || 0) + value;
                return stacks;
            }, []));
        })]);

        groups = chart.append('g')
            .selectAll('.group')
            .data(data)
            .enter()
            .append('g')
            .attr('class', 'group');

        bars = groups.selectAll('g')
            .data(function(d) { return d.values; })
            .enter()
            .append('g');

        rects = bars.append('rect')
            .attr('fill', function(d, i) { return cScale(i); });

        rects.append('title')
            .text(function(d) { return d; });

        legend = svg.selectAll('.legend')
            .data(labels)
            .enter()
            .append('g')
            .attr('class', 'legend');

        lrects = legend.append('rect')
            .attr('width', 18)
            .attr('height', 18)
            .style('fill', function(d, i) { return cScale(i); });

        ltexts = legend.append('text')
            .attr('y', 9)
            .attr('dy', '.35em')
            .style('text-anchor', 'end')
            .text(function(d) { return d; });

        resize();
    });
</script>
