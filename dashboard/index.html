<html>
    <head>
        <meta charset="utf-8">
        <script src="//cdnjs.cloudflare.com/ajax/libs/require.js/2.3.3/require.min.js"></script>
        <style>
            * {
                -moz-box-sizing: border-box;
                -webkit-box-sizing: border-box;
                box-sizing: border-box;
                font-family: arial;
            }
            body {
                margin: 0;
                padding: 0;
                overflow: hidden;
            }
            #dom  {
                width: 100%;
                height: 100%;
                overflow: hidden;
                background-color: #444;
            }
            #container {
                display: table;
                height: 100%;
                margin: auto;
            }
            #form {
                display: table-cell;
                vertical-align: middle;
            }
            #form iframe {
                border: none;
                width: 400px;
            }
            .frame {
                position: absolute;
                overflow: hidden;
                background-color: #ddd;
            }
            .image {
                background-repeat: no-repeat;
                background-position: center;
                background-size: cover;
            }
            .label {
                font-family: encode;
            }
            .link {
                font-family: encode;
                display: block;
                height: 16px;
                background-color: #ddd;
                border-radius: 4px;
                text-align: center;
                font-size: 12px;
                text-decoration: none;
                color: rgb(0, 0, 238);
                line-height: 125%;
            }
            .link:hover {
                background-color: #fff;
                color: #f00;
            }
            #overlay, #creation_popup, #edition_popup, #popup_overlay {
                position: absolute;
                top: 0;
                width: 100%;
                height: 100%;
                display: none;
            }
            #popup_overlay {
                background-color: #000;
                opacity: 0.6;
            }
            #creation_popup, #edition_popup {
                border: none;
            }
            .mask {
                position: absolute;
                cursor: pointer;
                background-color: #ffffff;
                opacity: 0.3;
            }
        </style>
    </head>
    <body>
        <div id="dom"></div>
        <div id="overlay"></div>
        <div id="popup_overlay"></div>
        <iframe id="creation_popup" src="../forms/?datauri=data:text/plain,uri:URI%2c[cancel]:Cancel"></iframe>
        <iframe id="edition_popup" src="../forms/?datauri=data:text/plain,uri:URI%2c[cancel]:Cancel%2c[refresh]:Refresh%2c[newpage]:New page%2c[delete]:Delete"></iframe>
        <script>
            require.config({
                baseUrl: '//cdn.rawgit.com/ehouais',
                paths: {
                    'jquery': '//cdnjs.cloudflare.com/ajax/libs/jquery/3.1.0/jquery.min',
                    'immutable': '//cdnjs.cloudflare.com/ajax/libs/immutable/3.8.1/immutable.min',
                    'sjcl': '//cdnjs.cloudflare.com/ajax/libs/sjcl/1.0.6/sjcl.min',
                    'observable': 'js-data-libs/v0.3.0/observable',
                    'streams': 'js-data-libs/v0.3.0/streams',
                    'http': 'js-data-libs/v0.4.0/http',
                    //'ui-utils': 'js-ui-utils/v0.4.0/ui-utils',
                    //'gist-fs': '//rawgit.com/ehouais/js-data-libs/dev/gist-fs',
                    'on-demand': '//rawgit.com/ehouais/js-data-libs/dev/on-demand',
                    'crypto': '//rawgit.com/ehouais/js-data-libs/dev/crypto',
                    'webviews': 'webviews/v0.3.0/webviews'
                },
                shim: {
                    'sjcl': {
                        exports: 'sjcl'
                    }
                },
            });
            require(['observable', 'jquery', 'crypto', 'on-demand', 'http'], function(Observable, $, crypto, OnDemand, Http) {
                var debounce = function(func, wait, immediate) {
                        var timeout;
                        return function() {
                            var context = this, args = arguments;
                            var later = function() {
                                timeout = null;
                                if (!immediate) func.apply(context, args);
                            };
                            var callNow = immediate && !timeout;
                            clearTimeout(timeout);
                            timeout = setTimeout(later, wait);
                            if (callNow) func.apply(context, args);
                        };
                    },
                    Cache = function(id, cb, delay) {
                        var debounced = debounce(cb, delay);

                        return function(data) {
                            localStorage.setItem(id, data);
                            debounced(data);
                        };
                    },
                    uriParams = function(uri) {
                        var a = document.createElement('a');
                        a.href = uri;
                        return a.search.replace(/^\?/, '').split('&').reduce(function(obj, pair) {
                            var tokens = pair.split('=');
                            obj[tokens[0]] = decodeURIComponent(tokens[1]);
                            return obj;
                        }, {});
                    },
                    dataSource = (function(uri){
                        var o = Observable(),
                            cipherKey = OnDemand(sessionStorage, 'cipherKey');

                        o.save = Cache('dataCache', function(data) {
                            Http.put(uri, crypto.cipher(cipherKey(), data), function() {}, true);
                        }, 5000);

                        o.bind = function(handler) {
                            Http.get(uri, function(data) {
                                handler(crypto.decipher(cipherKey(), data));
                            }, true);
                        };

                        return o;
                    })(uriParams(window.location.href).datauri),
                    maxId = 0,
                    dashboard,
                    formDomain = document.location.origin,
                    refresh = function() {
                        dataSource.save(JSON.stringify(dashboard));
                        dataSource.trigger();
                    };

                var $db = $(document.body),
                    $dom = $('#dom'),
                    $getFrame = function(id) {
                        return $('#frame_'+id, $dom);
                    },
                    setFrame = function($dom, frame) {
                        var left, top;

                        $dom.css({left: left = frame.left, top: top = frame.top}).width(frame.right-left).height(frame.bottom-top);
                    };

                dataSource.bind(function(data) {
                    var $frames = $('.frame', $dom);

                    dashboard = JSON.parse(data || '{"frames": []}');
                    dashboard.favicon && $('<link>').attr({rel: 'icon', type: 'image/png', href: dashboard.favicon}).appendTo($('head'));

                    dashboard.frames.forEach(function(frame, index) {
                        var $frame = $getFrame(frame.id = frame.id || index),
                            setup = function() {
                                // apply template according to resource type
                                if (frame.uri.match(/\.(jpg|jpeg|png|gif)$/)) {
                                    $frame.addClass('image').css('background-image', 'url('+frame.uri+')');
                                } else {
                                    $frame.append($('<iframe/>').attr({src: frame.uri, frameborder: 0}).css({width: '100%', height: '100%'}));
                                }
                                $frame.data('uri', frame.uri);
                            };

                        // keep track of highest id
                        maxId = Math.max(maxId, frame.id);

                        if ($frame.length) {
                            // reset frame if URI has changed
                            if (frame.uri != $frame.data('uri')) {
                                $frame.empty().removeClass('image').css('background-image', 'none');
                                setup();
                            }
                            // remove node from list of missing nodes
                            $frames = $frames.not($frame[0]);
                        } else {
                            // create and setup frame
                            $frame = $('<div/>').attr('id', 'frame_'+frame.id).addClass('frame').appendTo($dom);
                            setup();
                        }
                        // update link to data
                        $frame.data('frame', frame);
                        // set frame position and size
                        setFrame($frame, frame);
                    });

                    // remove orphan DOM nodes
                    $frames.remove();
                });

                // Setup controllers
                (function() {
                    var $overlay = $('#overlay'),
                        $creation_popup = $('#creation_popup'),
                        $edition_popup = $('#edition_popup'),
                        step = 4,
                        selected,
                        updateMask = function($mask) {
                            setFrame($mask, $getFrame($mask.data('frame_id')).data('frame'));
                        },
                        frame = function(width, height, uri) {
                            var cx = $dom.width()/2,
                                cy = $dom.height()/2;

                            dashboard.frames.push({
                                id: ++maxId,
                                left: 0|cx-width/2,
                                right: 0|cx+width/2,
                                top: 0|cy-height/2,
                                bottom: 0|cy+height/2,
                                uri: uri,
                            });
                            refresh();
                        };

                    // Prevent some default behaviours
                    $dom.on('mousedown mousewheel', function(e) {
                        e.preventDefault();
                    });

                    // edit mode toggle ans masks creation
                    $dom.on('mousedown', function() {
                        var tid,
                            clear = function() {
                                clearTimeout(tid);
                                $dom.off('mouseup', clear);
                            };

                        $dom.on('mouseup', clear);
                        tid = setTimeout(function() {
                            dashboard.frames.forEach(function(frame) {
                                updateMask($('<div/>').addClass('mask').data('frame_id', frame.id).appendTo($overlay));
                            });
                            $overlay.show();
                        }, 500);
                    });

                    // edition popup
                    $overlay.on('dblclick', '.mask', function(e) {
                        var $mask = $(e.target),
                            $frame = $getFrame($mask.data('frame_id')),
                            frame = $frame.data('frame');
                            onMessage = function(e) {
                                var event = e.originalEvent,
                                    msg = event.data,
                                    iframe,
                                    tokens,
                                    uri;

                                if (event.origin == formDomain && msg.type != 'resize') {
                                    if (msg.type == 'submit' && msg.data.uri != '') {
                                        frame.uri = msg.data.uri;
                                        refresh();
                                    } else if (msg.type == 'refresh') {
                                        iframe = $('iframe', $frame)[0];
                                        tokens = frame.uri.split('?');
                                        uri = tokens[0]+(tokens[1] ? '?'+tokens[1]+'&' : '?')+'random='+(new Date()).getTime();
                                        if (iframe) {
                                            iframe.src = uri;
                                        } else {
                                            $frame.css('background-image', 'url('+uri+')');
                                        }
                                    } else if (msg.type == 'newpage') {
                                        window.open(frame.uri);
                                    } else if (msg.type == 'delete' && confirm('Are you sure ?')) {
                                        $mask.remove();
                                        dashboard.frames = dashboard.frames.filter(function(item) {
                                            return item !== frame;
                                        });
                                        refresh();
                                    }
                                    $edition_popup.hide();
                                    $('#popup_overlay').hide();
                                    $(window).off('message', onMessage);
                                }
                            };

                        $edition_popup[0].contentWindow.postMessage({type: 'set', values: {uri: decodeURI(frame.uri)}}, formDomain);
                        $edition_popup.show();
                        $('#popup_overlay').show();
                        $(window).on('message', onMessage);
                    });

                    // Creation popup using "Forms" webview
                    $dom.on('dblclick', function() {
                        var onMessage = function(e) {
                                var event = e.originalEvent,
                                    msg = event.data;

                                if (event.origin == formDomain && msg.type != 'resize') {
                                    if (msg.type == 'submit' && msg.data.uri != '') {
                                        frame(200, 200, msg.data.uri);
                                    }
                                    $creation_popup.hide();
                                    $('#popup_overlay').hide();
                                    $(window).off('message', onMessage);
                                }
                            };

                        $creation_popup.show();
                        $('#popup_overlay').show();
                        $(window).on('message', onMessage);
                    });

                    // Overlay installment for frames manipulation
                    $overlay.on('click', function(e) {
                        if (selected) {
                            $(selected).css('background-color', '#ffffff');
                        }
                        if (e.target == $overlay.get(0)) {
                            selected = null;
                            $('.mask', $overlay).remove();
                            $overlay.hide();
                        } else {
                            selected = e.target;
                            $(selected).css('background-color', '#ff0000');
                        }
                    });

                    // Frame handling through masks
                    $overlay.on('mousedown', '.mask', function(e) {
                        var $mask = $(e.target),
                            $frame = $getFrame($mask.data('frame_id')),
                            frame = $frame.data('frame'),
                            mx = e.pageX, my = e.pageY,
                            dx1 = mx-frame.left, dy1 = my-frame.top,
                            dx2 = frame.right-mx, dy2 = frame.bottom-my,
                            moving = (dx2 > 10 || dy2 > 10),
                            snap = function(val) {
                                return val-val%step;
                            },
                            mm = function(e) {
                                frame = $frame.data('frame'),
                                mx = e.pageX;
                                my = e.pageY;
                                if (moving) {
                                    frame.left = snap(mx-dx1);
                                    frame.top = snap(my-dy1);
                                }
                                frame.right = snap(mx+dx2);
                                frame.bottom = snap(my+dy2);
                                updateMask($mask);
                                refresh();
                            },
                            mu = function() {
                                $overlay.off('mousemove', mm).off('mouseup', mu);
                            };

                        $overlay.on('mousemove', mm).on('mouseup', mu);
                        e.preventDefault();
                    });

                    $overlay.on('mousedown mousewheel', function(e) {
                        e.preventDefault();
                    });

                    // DnD
                    $dom.on({
                        'dragstart dragenter dragleave dragover dragend': function noop(e) {
                            e.stopPropagation();
                            e.preventDefault();
                        },
                        'drop': function(e) {
                            noop(e);
                            var link = e.originalEvent.dataTransfer.getData('text/uri-list');
                            frame(200, 200, link);
                        }
                    });
                })();
            });
        </script>
    </body>
</html>
