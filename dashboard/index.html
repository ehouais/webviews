<html>
    <head>
        <meta charset="utf-8">
        <link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAMhSURBVFhHtZc/aBNxFMcPO4igoIO2uogQETGl+d+kiB0cHTrUotBJAg6im2uJm4PZFHQQiuBYHCTgIog4iODgpLZ1cNCllGJqKYIm8fM93oXL9Xq5wN0XHr+7997vfb+/9/vlLucEUSqVbmKfi8ViL8oKhUKoP8I61P2AzRvVIKampi4QfIt1y+VyLw2jtoT8ZXzB/YRRO04+nz9PYLNarfYqlYpW18bWsFUbQ405oX5ZIKY669ju9PR0TzzEv+ZyueOegPdySiFJS6buQKPRSMRUa2FhYYzFnYH4kbohPrieOTjqIraVN1xFKUPE6gRjWzffbG9+cQ6OWk6qgC+LdeDsqQPuAUHIqsUTA1vbZKUf4ZgzlwvtPXy/tfABAbZfiQDyebVZWyuD7Mns7OxhxfCPw7cdFLCWlACtkLobqqv6spmZmR6ibiieugBqrWj1HrmIGEV4TvFUBVBn0U8u0z1dqVtKegJo8SnqbflbL3L8LUtxkZoAarT8q7fWb0mYpbhIRQB16n5yme6pu2gpfSQugBWepo5bUPWo5ZGvWMoABgQoeYiAMRv3BXNf+1dvZ2Cj/7IJIHYH8N0neZUVXjPXHhC77SeX6R5/+HsfxBKA/4EK6SmmOAWvW6gPVniWvF2v9T7y55YSiqEC8NVrtVq/qBLDRDDnnQR6ecph/Dk5OXnMUkIRR8BVrcS/sqAI8u8qx4vL7JV+RfEoDBUgQHTHXiKK9UVw3SF2zyvgkUsMvqc2PRKxBAjE+iI8Ipm/7TJr/XdeOEdsaiRiCxCIh4rwm23NZZsyFCMJEPzbESS31j+01FgYWYBA3h4RthVr/ME8ZGmxsJ+Aof+I/J2QaR7zL1o4NviJn4CvHRSwbvFIkHeLiX/Ueh5ES+YeCXpEU2fHFcDFJ10gZCebzY5bTiT0BKQbJbsdGXBVWHQX7q6KzakLdpgeW06qgO+V8W16jpfeZxnXywSKOihJmTpLzZN07RJjSzz2ZdR0BdCOCbbhi5xMcA8Ywe0ETd+a7neA6hv5m4Ffjw4GCcvYBl3oKjlpo+4/xh+QNzOZzEHHcZz/Yu4UxPJ023QAAAAASUVORK5CYII=">
        <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
        <script src="http://dev.ehouais.net/webviews/webviews.js"></script>
        <style>
			* {
				-moz-box-sizing: border-box;
				-webkit-box-sizing: border-box;
				box-sizing: border-box;
				font-family: arial;
			}
			body {
				margin: 0;
				padding: 0;
				overflow: hidden;
			}
			#dom  {
				width: 100%;
				height: 100%;
				overflow: hidden;
				background-color: #a0c0f0;
			}
            #container {
                display: table;
                height: 100%;
                margin: auto;
            }
            #form {
                display: table-cell;
                vertical-align: middle;
            }
            #form iframe {
                border: none;
                width: 400px;
            }
			.frame {
				position: absolute;
				overflow: hidden;
				background-color: rgba(255, 255, 255, 0.2);
			}
            .image {
                background-repeat: no-repeat;
                background-position: center;
                background-size: cover;
            }
			.label {
				font-family: encode;
			}
			.link {
				font-family: encode;
				display: block;
				height: 16px;
				background-color: #ddd;
				border-radius: 4px;
				text-align: center;
				font-size: 12px;
				text-decoration: none;
				color: rgb(0, 0, 238);
				line-height: 125%;
			}
			.link:hover {
				background-color: #fff;
				color: #f00;
			}
			#overlay, #creation_popup, #edition_popup, #popup_overlay {
				position: absolute;
				top: 0;
				width: 100%;
				height: 100%;
                display: none;
			}
            #popup_overlay {
                background-color: #000;
                opacity: 0.6;
            }
            #creation_popup, #edition_popup {
                border: none;
            }
			.mask {
				position: absolute;
				cursor: pointer;
				background-color: #ffffff;
				opacity: 0.3;
			}
        </style>
        <script>
			var dataSource = Webviews.data(),
                maxId = 0,
                dashboard,
                formDomain = 'http://webviews.local',
                refresh = function() {
                    dataSource.save(JSON.stringify(dashboard));
                    dataSource.trigger();
                };

			$(function() {
				var $db = $(document.body),
				    $dom = $('#dom'),
                    $getFrame = function(id) {
                        return $('#frame_'+id, $dom);
                    },
                    setFrame = function($dom, frame) {
                        var left, top;

                        $dom.css({left: left = frame.left, top: top = frame.top}).width(frame.right-left).height(frame.bottom-top);
                    };

                dataSource.bind(function(data) {
                    var $frames = $('.frame', $dom);

                    (dashboard = JSON.parse(data) || {frames: []}).frames.forEach(function(frame, index) {
                        var $frame = $getFrame(frame.id = frame.id || index),
                            setup = function() {
                                // apply template according to resource type
                                if (frame.uri.match(/\.(jpg|png)$/)) {
                                    $frame.addClass('image').css('background-image', 'url('+frame.uri+')');
                                } else {
                                    $frame.append($('<iframe/>').attr({src: frame.uri, frameborder: 0}).css({width: '100%', height: '100%'}));
                                }
                                $frame.data('uri', frame.uri);
                            };

                        // keep track of highest id
                        maxId = Math.max(maxId, frame.id);

                        if ($frame.length) {
                            // reset frame if URI has changed
                            if (frame.uri != $frame.data('uri')) {
                                $frame.empty().removeClass('image').css('background-image', 'none');
                                setup();
                            }
                            // remove node from list of missing nodes
                            $frames = $frames.not($frame[0]);
                        } else {
                            // create and setup frame
                            $frame = $('<div/>').attr('id', 'frame_'+frame.id).addClass('frame').appendTo($dom);
                            setup();
                        }
                        // update link to data
                        $frame.data('frame', frame);
                        // set frame position and size
                        setFrame($frame, frame);
                    });

                    // remove orphan DOM nodes
                    $frames.remove();
                });

                // Setup controllers
				(function() {
                    var $overlay = $('#overlay'),
                        $creation_popup = $('#creation_popup'),
                        $edition_popup = $('#edition_popup'),
				        step = 4,
                        selected,
                        updateMask = function($mask) {
                            setFrame($mask, $getFrame($mask.data('frame_id')).data('frame'));
                        },
                        frame = function(width, height, uri) {
                            var cx = $dom.width()/2,
                                cy = $dom.height()/2;

                            dashboard.frames.push({
                                id: ++maxId,
                                left: 0|cx-width/2,
                                right: 0|cx+width/2,
                                top: 0|cy-height/2,
                                bottom: 0|cy+height/2,
                                uri: uri
                            });
                            refresh();
                        };

                    // Prevent some default behaviours
					$dom.on('mousedown mousewheel', function(e) {
						e.preventDefault();
					});

                    // edit mode toggle ans masks creation
                    $dom.on('mousedown', function() {
                        var tid,
                            clear = function() {
                                clearTimeout(tid);
                                $dom.off('mouseup', clear);
                            };

                        $dom.on('mouseup', clear);
                        tid = setTimeout(function() {
                            dashboard.frames.forEach(function(frame) {
                                updateMask($('<div/>').addClass('mask').data('frame_id', frame.id).appendTo($overlay));
                            });
                            $overlay.show();
                        }, 500);
                    });

                    // edition popup
                    $overlay.on('dblclick', '.mask', function(e) {
                        var $mask = $(e.target),
                            $frame = $getFrame($mask.data('frame_id')),
                            frame = $frame.data('frame');
                            onMessage = function(e) {
                                var event = e.originalEvent,
                                    msg = event.data;

                                if (event.origin == formDomain && msg.type != 'resize') {
                                    if (msg.type == 'submit' && msg.data.uri != '') {
                                        frame.uri = msg.data.uri;
                                        refresh();
                                    } else if (msg.type == 'refresh') {
                                        // TODO check if img background
                                        $('iframe', $frame)[0].src = $('iframe', $frame)[0].src;
                                    } else if (msg.type == 'newpage') {
                                        window.open(frame.uri);
                                    } else if (msg.type == 'delete' && confirm('Are you sure ?')) {
                                        $mask.remove();
                                        dashboard.frames = dashboard.frames.filter(function(item) {
                                            return item !== frame;
                                        });
                                        refresh();
                                    }
                                    $edition_popup.hide();
                                    $('#popup_overlay').hide();
                                    $(window).off('message', onMessage);
                                }
                            };

                        $edition_popup[0].contentWindow.postMessage({type: 'set', values: {uri: decodeURI(frame.uri)}}, formDomain);
                        $edition_popup.show();
                        $('#popup_overlay').show();
                        $(window).on('message', onMessage);
                    });

                    // Creation popup using "Forms" webview
					$dom.on('dblclick', function() {
						var onMessage = function(e) {
                            var event = e.originalEvent,
                                msg = event.data;

                                if (event.origin == formDomain && msg.type != 'resize') {
                                    if (msg.type == 'submit' && msg.data.uri != '') {
                                        frame(200, 200, msg.data.uri);
                                    }
                                    $creation_popup.hide();
                                    $('#popup_overlay').hide();
                                    $(window).off('message', onMessage);
                                }
                            };

                        $creation_popup.show();
                        $('#popup_overlay').show();
                        $(window).on('message', onMessage);
					});

					// Overlay installment for frames manipulation
					$overlay.on('click', function(e) {
						if (selected) {
							$(selected).css('background-color', '#ffffff');
						}
						if (e.target == $overlay.get(0)) {
							selected = null;
                            $('.mask', $overlay).remove();
							$overlay.hide();
						} else {
							selected = e.target;
							$(selected).css('background-color', '#ff0000');
						}
					});

                    // Frame handling through masks
					$overlay.on('mousedown', '.mask', function(e) {
						var $mask = $(e.target),
                            $frame = $getFrame($mask.data('frame_id')),
                            frame = $frame.data('frame'),
						    mx = e.pageX, my = e.pageY,
						    dx1 = mx-frame.left, dy1 = my-frame.top,
						    dx2 = frame.right-mx, dy2 = frame.bottom-my,
						    moving = (dx2 > 10 || dy2 > 10),
                            snap = function(val) {
                                return val-val%step;
                            },
							mm = function(e) {
                                frame = $frame.data('frame'),
								mx = e.pageX;
								my = e.pageY;
								if (moving) {
									frame.left = snap(mx-dx1);
                                    frame.top = snap(my-dy1);
								}
								frame.right = snap(mx+dx2);
                                frame.bottom = snap(my+dy2);
                                updateMask($mask);
                                refresh();
							},
							mu = function() {
								$overlay.off('mousemove', mm).off('mouseup', mu);
							};

						$overlay.on('mousemove', mm).on('mouseup', mu);
						e.preventDefault();
					});
					$overlay.on('mousedown mousewheel', function(e) {
						e.preventDefault();
					});

                    // DnD
					$dom.on({
						'dragstart dragenter dragleave dragover dragend': function noop(e) {
    						e.stopPropagation();
    						e.preventDefault();
    					},
						'drop': function(e) {
							noop(e);
							var link = e.originalEvent.dataTransfer.getData('text/uri-list');
							frame(200, 200, link);
						}
					});
				})();
			});
        </script>
    </head>
    <body>
        <div id="dom"></div>
        <div id="overlay"></div>
        <div id="popup_overlay"></div>
        <iframe id="creation_popup" src="http://webviews.local/forms?datauri=data:text/plain,uri:URI,[cancel]:Cancel"></iframe>
        <iframe id="edition_popup" src="http://webviews.local/forms?datauri=data:text/plain,uri:URI,[cancel]:Cancel,[refresh]:Refresh,[newpage]:New page,[delete]:Delete"></iframe>
    </body>
</html>
