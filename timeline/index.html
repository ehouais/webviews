<!DOCTYPE html>
<meta charset="utf-8">
<style>
    @font-face {
        font-family: encode;
        src: url('http://static.ehouais.net/EncodeSansCondensed-Regular.ttf') format("truetype");
    }
    body {
        font-family: encode;
        margin: 0;
        border: 0;
        overflow: hidden;
    }
    .chart text {
      fill: white;
      font: 10px sans-serif;
      text-anchor: middle;
    }
    .axis text {
        font-size: 10px;
    }
    .axis path, .axis line {
        fill: none;
        stroke: #000;
        shape-rendering: crispEdges;
    }
    .axis.major path {
        display: none;
    }
    .axis.major .line line {
        stroke: #999;
        stroke-dasharray: 2,2,1,0;
    }
    .axis.minor .line line {
        stroke: #999;
        stroke-dasharray: 1,4;
    }
</style>
<body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
<script>
    var FR = d3.locale({
            decimal: ",",
            thousands: ".",
            grouping: [3],
            currency: ["", " €"],
            dateTime: "%A, le %e %B %Y, %X",
            date: "%d/%m/%Y",
            time: "%H:%M:%S",
            periods: ["AM", "PM"], // unused
            days: ["dimanche", "lundi", "mardi", "mercredi", "jeudi", "vendredi", "samedi"],
            shortDays: ["dim.", "lun.", "mar.", "mer.", "jeu.", "ven.", "sam."],
            months: ["janvier", "février", "mars", "avril", "mai", "juin", "juillet", "août", "septembre", "octobre", "novembre", "décembre"],
            shortMonths: ["janv.", "févr.", "mars", "avr.", "mai", "juin", "juil.", "août", "sept.", "oct.", "nov.", "déc."]
        }),
        start,
        end,
        svg = d3.select('body').append('svg'),
        chart = svg.append('g'),
        margin = {top: 10, right: 10, bottom: 20, left: 10},
        xScale = d3.time.scale(),
        minor = chart.append('g')
            .attr('class', 'x axis minor'),
        mtAxis = d3.svg.axis()
            .scale(xScale)
            .outerTickSize(0),
        mticks = minor.append('g'),
        mlAxis = d3.svg.axis()
            .scale(xScale)
            .tickFormat(''),
        mlines = minor.append('g')
            .attr('class', 'line'),
        major = chart.append('g')
            .attr('class', 'x axis major'),
        MtAxis = d3.svg.axis()
            .scale(xScale)
            .tickSize(20),
        Mticks = major.append('g'),
        MlAxis = d3.svg.axis()
            .scale(xScale)
            .tickFormat(''),
        Mlines = major.append('g')
            .attr('class', 'line'),
        yScale = d3.scale.ordinal(),
        cScale = d3.scale.category10(),
        lines,
        titles,
        bars,
        rects,
        texts;

    var dataUri = (function(str) {
            var a = document.createElement('a');
            a.href = str;
            return a.search.replace(/^\?/, '').split('&').reduce(function(obj, pair) {
                var tokens = pair.split('=');
                obj[tokens[0]] = tokens[1];
                return obj;
            }, {});
        })(window.location.href).datauri;

    var resize = window.onresize = function() {
            var width = window.innerWidth,
                height = window.innerHeight,
                am = {
                    top: height*margin.top/100,
                    right: width*margin.right/100,
                    bottom: height*margin.bottom/100,
                    left: width*margin.left/100
                },
                cwidth = width-am.left-am.right,
                cheight = height-am.top-am.bottom,
                findInterval = function (val, bounds) {
                    var index = 0;
                    while (bounds[index] && val < bounds[index]) index++;
                    return index;
                },
                mode = findInterval((end-start)/(24*60*60*1000)/cwidth, [14, 7, 2, 1.2, 0.6, 0.3]),
                ticks = [ // major interval, major format, minor interval, minor format
                    [   null,    null,   'year', 1, '\'%y'],
                    [   null,    null,   'year', 1,   '%Y'],
                    [ 'year',    '%Y',  'month', 3,   '%m'],
                    [ 'year',    '%Y',  'month', 1,   '%m'],
                    [ 'year',    '%Y',  'month', 1,   '%b'],
                    [ 'year',    '%Y',  'month', 1,   '%B'],
                    ['month', '%B %Y', 'monday', 1,   '%d']
                ][mode],
                fs = Math.max(Math.min(height/20, 20), 11);

            svg
                .attr('width', width)
                .attr('height', height);

            chart
                .attr('transform', 'translate('+am.left+','+am.top+')');

            xScale
                .range([0, cwidth]);

            major.style('display', ticks[0] ? 'block' : 'none');
            if (ticks[0]) {
                MtAxis
                    .ticks(d3.time[ticks[0]])
                    .tickFormat(FR.timeFormat(ticks[1]));

                Mticks
                    .attr('transform', 'translate(0,' + cheight + ')')
                    .call(MtAxis)
                    .selectAll('.tick text')
                    .style('text-anchor', 'start')
                    .attr('x', 2)
                    .attr('y', 15);

                MlAxis
                    .ticks(d3.time[ticks[0]])
                    .tickSize(-cheight, 0);

                Mlines
                    .attr('transform', 'translate(0,' + cheight + ')')
                    .call(MlAxis);
            }

            mtAxis
                .ticks(d3.time[ticks[2]], ticks[3])
                .tickFormat(FR.timeFormat(ticks[4]));

            mticks
                .attr('transform', 'translate(0,' + cheight + ')')
                .call(mtAxis)
                .selectAll(".tick text")
                .style("text-anchor", "start")
                .attr("x", 2)
                .attr("y", 4)/*
                .classed('hidden', cwidth < 350)*/;

            mlAxis
                .ticks(d3.time[ticks[2]], ticks[3])
                .tickSize(-cheight, 0);

            mlines
                .attr('transform', 'translate(0,' + cheight + ')')
                .call(mlAxis);

            yScale
                .rangeRoundBands([0, cheight], 0.7);

            lines
                .attr('transform', function(d, i) { return 'translate(0,'+yScale(i)+')'; });

            titles
                .style('font-size', fs)
                .attr('y', function(d) { return yScale.rangeBand()/2+fs/4; });

            rects
                .attr('x', function(d) { return xScale(d.period.start); })
                .attr('width', function(d) { return xScale(d.period.end)-xScale(d.period.start); })
                .attr('height', yScale.rangeBand());

            texts
                .style('font-size', fs)
                .attr('x', function(d) { return xScale(d.period.start); })
                .attr('y', function(d) { return -fs/4; });
        };

    d3.xhr(dataUri).get().on('load', function(xhr) {
        var parse = function(str) {
                var res;
                if (res = str.match(/(\d{2})\/(\d{2})(\/(\d+))?/)) {
                    return new Date(res[4] > 99 ? res[4] : (res[4] || 0) + new Date().getFullYear(), res[2]-1, res[1]);
                }
            },
            strToPeriod = function(str) {
                var tokens = str.split('-'),
                    date;
                if (tokens.length > 1) {
                    return  {
                        start:parse(tokens[0]),
                        end: new Date(+parse(tokens[1])+24*60*60*1000)
                    }
                } else {
                    return {
                        start: date = parse(str),
                        end: new Date(+date+24*60*60*1000)
                    }
                }
            },
            res,
            delta,
            data;

        start = +Infinity,
        end = -Infinity;

        data = xhr.response.split('|').map(function(str) {
            var line = {label: 'noname', events: []},
                res,
                events = [],
                event,
                period;
            if (res = str.match(/^([^\[]+)(.*)/)) {
                line.label = res[1];
                margin.left = 15;
                str = res[2];
            }
            while (res = str.match(/\[([^\]]+)]([^\[]+)(.*)/)) {
                event = {label: res[2], str: res[1], period: strToPeriod(res[1])};
                line.events.push(event);
                start = Math.min(start, event.period.start);
                end = Math.max(end, event.period.end);
                str = res[3];
            }
            return line;
        });

        delta = (end-start)/10;
        start = new Date(start-delta);
        end = new Date(end+delta);

        xScale
            .domain([start, end]);

        yScale
            .domain(d3.range(data.length));

        lines = chart.append('g')   // lines container
            .selectAll('g')         // lines
            .data(data)
            .enter()
            .append('g')
            .style('fill', function(d, i) { return cScale(i); });

        titles = lines.append('text')
            .text(function(d) { return d.label; })
            .style('text-anchor', 'end');

        bars = lines.selectAll('g')      // line events
            .data(function(d) { return d.events; })
            .enter()
            .append('g');

        rects = bars.append('rect');

        rects.append('title')
            .text(function(event) { return event.str; });

        texts = bars.append('text')
            .text(function(event) { return event.label; })
            .style('fill', '#000');

        resize();
    });
</script>
