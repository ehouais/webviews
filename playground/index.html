<html>
    <head>
        <meta charset="utf-8">
        <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
        <script src="http://dev.ehouais.net/webviews/webviews.js"></script>
        <link href="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.0/css/bootstrap.min.css" rel="stylesheet">
        <script src="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.0/js/bootstrap.min.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/markdown-it/4.2.2/markdown-it.js"></script>
        <style>
            .container {
                margin-top: 50px;
            }
            #render {
                border: 1px solid #ddd;
                width: 100%;
                height: 300px;
                margin-bottom: 20px;
            }
            #source {
                width: 100%;
                min-height: 200px;
                font-family: monospace;
                font-size: 12px;
                margin-top: 20px;
            }
            #doc h4 {
                margin-top: 30px;
            }
        </style>
        <script>
            (function() {
              var out$ = typeof exports != 'undefined' && exports || this;

              var doctype = '<?xml version="1.0" standalone="no"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">';

              function isExternal(url, win) {
                return url && url.lastIndexOf('http',0) == 0 && url.lastIndexOf((win || window).location.host) == -1;
              }

              function inlineImages(el, callback) {
                var images = el.querySelectorAll('image');
                var left = images.length;
                if (left == 0) {
                  callback();
                }
                for (var i = 0; i < images.length; i++) {
                  (function(image) {
                    var href = image.getAttributeNS('"http://www.w3.org/1999/xlink', 'href');
                    if (href) {
                      if (isExternal(href.value)) {
                        console.warn('Cannot render embedded images linking to external hosts: '+href.value);
                        return;
                      }
                    }
                    var canvas = document.createElement('canvas');
                    var ctx = canvas.getContext('2d');
                    var img = new Image();
                    href = href || image.getAttribute('href');
                    img.src = href;
                    img.onload = function() {
                      canvas.width = img.width;
                      canvas.height = img.height;
                      ctx.drawImage(img, 0, 0);
                      image.setAttributeNS('http://www.w3.org/1999/xlink', 'href', canvas.toDataURL('image/png'));
                      left--;
                      if (left == 0) {
                        callback();
                      }
                    }
                    img.onerror = function() {
                      console.log('Could not load '+href);
                      left--;
                      if (left == 0) {
                        callback();
                      }
                    }
                  })(images[i]);
                }
              }

              function styles(el, selectorRemap, doc) {
                var document = doc || document;
                var css = "";
                var sheets = document.styleSheets;
                for (var i = 0; i < sheets.length; i++) {
                  if (isExternal(sheets[i].href, document.defaultView)) {
                    console.warn('Cannot include styles from other hosts: '+sheets[i].href);
                    continue;
                  }
                  var rules = sheets[i].cssRules;
                  if (rules != null) {
                    for (var j = 0; j < rules.length; j++) {
                      var rule = rules[j];
                      if (typeof(rule.style) != 'undefined') {
                        var match = null;
                        try {
                          match = el.querySelector(rule.selectorText);
                        } catch(err) {
                          console.warn('Invalid CSS selector "' + rule.selectorText + '"', err);
                        }
                        if (match) {
                          var selector = selectorRemap ? selectorRemap(rule.selectorText) : rule.selectorText;
                          css += selector + ' { ' + rule.style.cssText + ' }\n';
                        } else if(rule.cssText.match(/^@font-face/)) {
                          css += rule.cssText + '\n';
                        }
                      }
                    }
                  }
                }
                return css;
              }

              function getDimension(el, clone, dim) {
                return (clone.getAttribute(dim) !== null && !clone.getAttribute(dim).match(/%$/) && parseInt(clone.getAttribute(dim))) ||
                  el.getBoundingClientRect()[dim] ||
                  parseInt(clone.style[dim]) ||
                  parseInt(window.getComputedStyle(el).getPropertyValue(dim));
              }

              out$.svgAsDataUri = function(el, options, cb) {
                options = options || {};
                options.scale = options.scale || 1;
                var xmlns = 'http://www.w3.org/2000/xmlns/';

                inlineImages(el, function() {
                  var outer = document.createElement('div');
                  //$(outer).appendTo(document.body);
                  var clone = el.cloneNode(true);
                  var width, height, viewBoxWidth, viewBoxHeight;
                  if(el.tagName == 'svg') {
                    width = getDimension(el, clone, 'width');
                    height = getDimension(el, clone, 'height');
                    if (typeof width === 'undefined' || width === null || isNaN(parseFloat(width))) {
                      width = 0;
                    }
                    if (typeof height === 'undefined' || height === null || isNaN(parseFloat(height))) {
                      height = 0;
                    }
                    viewBoxWidth = el.viewBox.baseVal && el.viewBox.baseVal.width !== 0 ? el.viewBox.baseVal.width : width;
                    viewBoxHeight = el.viewBox.baseVal && el.viewBox.baseVal.height !== 0 ? el.viewBox.baseVal.height : height;
                  } else {
                    var box = el.getBBox();
                    width = box.x + box.width;
                    height = box.y + box.height;
                    clone.setAttribute('transform', clone.getAttribute('transform').replace(/translate\(.*?\)/, ''));
                    viewBoxWidth = width;
                    viewBoxHeight =  height;

                    var svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg')
                    svg.appendChild(clone)
                    clone = svg;
                  }

                  clone.setAttribute('version', '1.1');
                  if (!clone.getAttribute('xmlns')) {
                      clone.setAttributeNS(xmlns, 'xmlns', 'http://www.w3.org/2000/svg');
                  }
                  clone.setAttributeNS(xmlns, 'xmlns:xlink', 'http://www.w3.org/1999/xlink');
                  clone.setAttribute('width', width * options.scale);
                  clone.setAttribute('height', height * options.scale);
                  clone.setAttribute('viewBox', '0 0 ' + viewBoxWidth + ' ' + viewBoxHeight);

                  outer.appendChild(clone);

                  var css = styles(el, options.selectorRemap, options.document);
                  var s = document.createElement('style');
                  s.setAttribute('type', 'text/css');
                  s.innerHTML = '<![CDATA[\n' + css + '\n]]>';
                  var defs = document.getElementsByTagName('defs')[0] || document.createElement('defs');
                  defs.appendChild(s);
                  clone.insertBefore(defs, clone.firstChild);

                  var svg = doctype + outer.innerHTML;
                  // encode then decode to handle `btoa` on Unicode; see MDN for `btoa`.
                  var uri = 'data:image/svg+xml;base64,' + window.btoa(decodeURIComponent(encodeURIComponent(svg)));
                  if (cb) {
                    cb(uri);
                  }
                });
              }

              out$.saveSvgAsPng = function(el, name, options) {
                options = options || {};
                out$.svgAsDataUri(el, options, function(uri) {
                  var image = new Image();
                  //$(image).appendTo(document.body);
                  image.onload = function() {
                    var canvas = document.createElement('canvas');
                    canvas.width = image.width;
                    canvas.height = image.height;
                    var context = canvas.getContext('2d');
                    context.drawImage(image, 0, 0);

                    var a = document.createElement('a');
                    a.download = name;
                    a.href = canvas.toDataURL('image/png');
                    document.body.appendChild(a);
                    a.addEventListener('click', function(e) {
                      a.parentNode.removeChild(a);
                    });
                    a.click();
                  }
                  image.src = uri;
              });
              }
            })();
        </script>
        <script>
            $(function() {
                var parts = window.location.href.split('?'),
                    appUri = parts[0].replace(/playground\/?/, parts[1]),
                    $source = $('#source'),
                    iframeWindow = $('#render')[0].contentWindow,
                    $doc = $('#doc'),
                    dataFromUri = function(uri) {
                        return decodeURIComponent(uri.replace(/^[^\?]*\?datauri=data:[^,]+,/, ''));
                    },
                    uriFromData = function(data) {
                        return appUri+'?datauri=data:text/plain;charset%3Dutf-8,'+data;
                    },
                    updateViews = function(uri, data) {
                        uri != iframeWindow.location && iframeWindow.location.replace(uri);
                        data != $source.val() && $source.val(data);
                        $('#buttons button').prop('disabled', !data);
                    },
                    updateData = function(data) {
                        updateViews(uriFromData(data), data);
                    },
                    updateUri = function(uri) {
                        updateViews(uri, dataFromUri(uri));
                    },
                    debouncedUpdate = Webviews.debounce(updateData, 1000),
                    md = window.markdownit({
                        linkify: true
                    });

                // Display example in iframe
                $doc.on('click', 'a[href^="'+appUri+'"]', function(e) {
                    updateUri($(e.target).attr('href'));
                    e.preventDefault();
                });

                // Get webview documentation
                $.get(appUri, function(html) {
                    // get doc URI from header <link> tag
                    var docUri = $('link[rel="doc"]', $('<div>').append(html)).attr('href');

                    if (docUri) {
                        // handle relative URI
                        if (!docUri.match(/^(https?|data):/)) {
                            docUri = appUri+'/'+docUri;
                        }

                        // Fetch documentation and insert it into page
                        $.get(docUri).done(function(data) {
                            $doc.html(md.render(data.replace(new RegExp('http://dev.ehouais.net/webviews/[^\? `]*', 'g'), appUri)));
                        });
                    }
                }, 'html');

                $source.on('input', function() {
                    debouncedUpdate($source.val());
                });
                $('#reset').on('click', function() {
                    updateData('');
                });
                $('#geturi').on('click', function() {
                    window.prompt('URL', iframeWindow.location);
                });
                $('#gethtml').on('click', function() {
                    window.prompt('URL', '<iframe src="'+iframeWindow.location+'">"</iframe>');
                });
                $('#saveaspng').on('click', function() {
                    // get SVG tag from iframe document
                    var document = iframeWindow.document
                    var svg = $('svg', document)[0];
                    saveSvgAsPng(svg, "diagram.png", {document: document});
                });
            });
        </script>
    </head>
    <body>
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <iframe id="render"></iframe>
                    <div id="buttons">
                        <button id="reset" class="btn btn-danger pull-right" disabled="disabled">Reset</button>
                        <button id="geturi" class="btn btn-default" disabled="disabled">URI</button>
                        <button id="gethtml" class="btn btn-default" disabled="disabled">Embed</button>
                            <button id="saveaspng" class="btn btn-default" disabled="disabled">Save as PNG</button>
                    </div>
                    <textarea id="source"></textarea>
                </div>
                <div class="col-md-6" id="doc"></div>
            </div>
        </div>
    </body>
</html>
